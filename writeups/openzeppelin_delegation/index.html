<!doctype html><html lang=en><head><title>Brazil0nChain</title>
<meta charset=utf-8><meta content="utf-8" http-equiv=encoding><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no"><meta name=theme-color content="#000084"><link rel=icon href=https://brazil0nchain.com//img/favicon.ico><link rel=canonical href=https://brazil0nchain.com/></head><body><nav class="navbar navbar-inverse navbar-fixed-top"><div class=navbar-inner><div class=container><button type=button class="btn btn-navbar" data-toggle=collapse data-target=.nav-collapse></button>
<a class=brand href=https://brazil0nchain.com/>Brazil0nChain</a><div class="nav-collapse collapse"><ul class=nav><li><a href=/sobre/><span>Sobre</span></a></li><li><a href=/post/><span>Posts</span></a></li><li><a href=/writeups/><span>Writeups</span></a></li></ul></div></div></div></nav><link rel=alternate type=application/rss+xml href=https://brazil0nchain.com//index.xml title=Brazil0nChain><div id=content class=container><div class="row-fluid navmargin"><div class=page-header><h1>OpenZeppelin - Delegation - Jan 27, 2025</h1></div><p class=lead>Writeup - EtherNaut (OpenZeppelin) / Delegation.</br>Author: Pedro Silva (demon-i386)</p><p>Writeup para resolução do desafio &ldquo;delegation&rdquo;, do CTF Ethernaut, do OpenZeppelin.
Neste writeup, apresentamos uma função bastante interessante utilizada na construção de smart contracts. Além de entender seu funcionamento, também vemos um caso de vulnerabilidade que pode ser explorado.</p><p><img src=../attachment/c443f8b24547f0eac7c7ea65b2bb79ae.png alt></p><p>O desafio começa com a seguinte proposta:</p><p><img src=../attachment/d73f9657c81f499aaaa980e61b820dc6.png alt></p><pre tabindex=0><code>O objetivo deste nível é que você reivindique a propriedade da instância do contrato que lhe foi fornecida.

  Coisas que podem ajudar

- Consulte a documentação do Solidity sobre a função de baixo nível &#34;delegatecall&#34;, como ela funciona, como pode ser usada para delegar operações para bibliotecas on-chain e quais implicações ela tem no escopo de execução.
- Métodos fallback
- IDs de método
</code></pre><p>Junto ao código do desafio:</p><p><img src=../attachment/fc51c17a343f36157b73b4bfdcbad055.png alt></p><p>Logo de cara, analisando o código, é possível identificar dois contratos: um chamado &lsquo;Delegation&rsquo; e outro &lsquo;Delegate&rsquo;.</p><p>É importante mencionar que, apesar de parecer que os contratos foram escritos dentro de um único arquivo, eles são completamente independentes, com dois contratos distintos sendo implantados na blockchain. Caso o contrato estivesse utilizando a palavra-chave &lsquo;is&rsquo;, ou seja, &lsquo;Contract Delegation is Delegate&rsquo;, estaríamos falando sobre herança, com a criação de um único contrato na blockchain, combinando a lógica de ambos, onde um estende as funcionalidades do outro. (<a href=https://docs.soliditylang.org/en/develop/contracts.html#inheritance>https://docs.soliditylang.org/en/develop/contracts.html#inheritance</a>"</p><p>Endereço do dono do contrato e endereço do jogador:</p><p><img src=../attachment/6e0efefec4bc89751f87c4a220e0b6ea.png alt></p><ul><li>Nosso objetivo é fazer o jogador virar o novo dono do contrato.</li></ul><p>Analisando o contrato, é possível destacar alguns pontos de interesse, como por exemplo uma função nunca antes vista, chamada &ldquo;<strong>delegatecall</strong>&rdquo;:</p><p><img src=../attachment/04b195151116d471013d897b4420c774.png alt></p><p>A função <strong>&ldquo;delegatecall&rdquo;</strong> faz parte de um conjunto de chamadas utilizadas para interações entre contratos, como <strong>&ldquo;call&rdquo;</strong> e <strong>&ldquo;callcode&rdquo;</strong>, mas com algumas diferenças entre elas:</p><p><strong>Linha tirada da documentação</strong>: <em>As mentioned in the introduction, if a library’s code is executed using a CALL instead of a DELEGATECALL or CALLCODE, it will revert unless a view or pure function is called.</em></p><p>{ li e fiquei curioso (????)</p><ul><li>função <strong>view</strong>: função que pode ler, mas não alterar variáveis definidas no estado;</li><li>função <strong>pure</strong>: função que não poder ler nem modificar o estado da blockchain;</li><li><strong>revert</strong>: reverte todas as mudanças realizadas na blockchain.
}</li></ul><p><strong>Call</strong>: O contrato A executa uma função no contrato B em um novo contexto, ou seja, o contrato B pode alterar suas próprias variáveis (estado/armazenamento), mas essas modificações não são refletidas no contrato A. (Modificações no contrato B não afetam o contrato A).</p><p><strong>Delegatecall / Callcode</strong>: O contrato A delega a execução de uma função ao contrato B, permitindo que o contrato B modifique o armazenamento do contrato A. (Modificações no contrato B são refletidas no armazenamento do contrato A).</p><p>Fica claro que a execução começa no contrato <strong>&ldquo;Delegation&rdquo;</strong>, e isso se torna ainda mais evidente quando enumeramos as funções que o contrato possui (não possui a função <strong>pwn()</strong>):</p><p><img src=../attachment/7d14f5e796e3d95850b8aa29b1917bbc.png alt></p><p>Investigando o segundo contrato, podemos observar uma função que é capaz de alterar a variável <strong>owner</strong>, que define o dono do contrato, para o valor recebido através da variável global <strong>msg.sender</strong>. A variável <strong>msg.sender</strong> representa o endereço da conta ou contrato externo que enviou ou executou a transação.</p><h3 id=exploit>Exploit</h3><p>(!!!!) - <strong>Plano</strong>: Através do contrato <strong>Delegation</strong>, vamos utilizar a função <strong>delegatecall</strong> para chamar a função <strong>pwn()</strong> do contrato <strong>Delegate</strong>. Isso fará com que a variável <strong>owner</strong> seja alterada para o endereço de quem originou a transação (no nosso caso, <strong>nós</strong>), assumindo assim a propriedade do contrato.</p><p><img src=../attachment/485f1acf182ea499aeed5b4cfe59d76c.png alt></p><p>Mas como interagir com o contrato Delegation para chegarmos ao trecho de código vulnerável? como passamos os argumentos para o &ldquo;<strong>delegatecall</strong>&rdquo;?</p><p>Observando o contrato Delegation é observado que o trecho de código está dentro de uma função chamada <strong>&ldquo;fallback()&rdquo;</strong>.</p><p>Segundo a documentação: <em>The receive function is executed on a call to the contract with empty calldata. This is the function that is executed on plain Ether transfers (e.g. via <code>.send()</code> or <code>.transfer()</code>). If no such function exists, but a payable <a href=https://docs.soliditylang.org/en/latest/contracts.html#fallback-function>fallback function</a> exists, the fallback function will be called on a plain Ether transfer. If neither a receive Ether nor a payable fallback function is present, the contract cannot receive Ether through a transaction that does not represent a payable function call and throws an exception.</em></p><p><em>The fallback function is executed on a call to the contract if none of the other functions match the given function signature, or if no data was supplied at all and there is no <a href=https://docs.soliditylang.org/en/latest/contracts.html#receive-ether-function>receive Ether function</a>. The fallback function always receives data, but in order to also receive Ether it must be marked <code>payable</code>.</em></p><p>A função <strong>fallback</strong> é uma função especial executada no contrato quando nenhuma outra função é encontrada para execução (através do seletor da - 4 bytes de <strong>msg.data</strong>). A forma padrão de invocar a função fallback é através de uma transação.</p><p>Podemos passar o argumento global <strong>msg.data</strong>, utilizado pelo <strong>delegatecall</strong>, através do argumento <strong>calldata</strong>, é a área de armazenamento onde os dados da transação (ex: parâmetros) são mantidos.</p><p>A função <strong>delegatecall</strong> leva como argumento a assinatura do método a ser executado dentro do contrato pré-definido. ( <strong>address(delegate).delegatecall(metodo_dentro_do_delegate)</strong> ).</p><p>A assinatura da função é composta pelos primeiros 4 bytes do <strong>keccak256</strong> (ou <strong>sha3</strong>) do seu nome e parâmetros, exemplo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// sha3 completo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>funcSig</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>web3</span>.<span style=color:#a6e22e>utils</span>.<span style=color:#a6e22e>sha3</span>(<span style=color:#e6db74>&#39;pwn()&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;0xdd365b8b15d5d78ec041b851b68c8b985bee78bee0b87c4acf261024d8beabab&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 4 bytes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>functionSignature</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>web3</span>.<span style=color:#a6e22e>eth</span>.<span style=color:#a6e22e>abi</span>.<span style=color:#a6e22e>encodeFunctionSignature</span>(<span style=color:#e6db74>&#34;pwn()&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;0xdd365b8b&#39;</span></span></span></code></pre></div><p>Para chamar a função <strong>fallback</strong> por meio da biblioteca <strong>web3.js</strong>, utilizada pelo OpenZeppelin, podemos utilizar a função <strong>sendTransaction</strong>, mas funções nativas do Solidity como <strong>call()</strong>, <strong>send()</strong> ou <strong>transfer()</strong> também funcionam.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>contract</span>.<span style=color:#a6e22e>sendTransaction</span>({<span style=color:#a6e22e>data</span><span style=color:#f92672>:</span><span style=color:#a6e22e>functionSignature</span>,<span style=color:#a6e22e>from</span><span style=color:#f92672>:</span><span style=color:#a6e22e>player</span>})</span></span></code></pre></div><p><img src=../attachment/d42cbbc3066bc58332acbd18a7e36085.png alt></p><p>Enviando a transação com o payload:</p><p><img src=../attachment/cc53f9148290272c34c1a71dc1fca898.png alt></p><p>Boom! somos os novos donos do contrato!</p><p><img src=../attachment/37dc865d1e62a4a659507c7e5c00c6e7.png alt></p><h4><a href=https://brazil0nchain.com/>Back to Home</a></h4></div></div><footer class=container><hr class=soften><p>RSS Feed habilitado! |
&copy;
demon-i386 / h4rry1337 |
<span id=thisyear>2025</span></p><script src=https://public.bnbstatic.com/unpkg/growth-widget/cryptoCurrencyWidget@0.0.19.min.js></script><div class=binance-widget-marquee data-cmc-ids=1,1027,52,5426,74,1958,11419,24478,5690,13502 data-theme=dark data-transparent=false data-locale=en data-fiat=USD></div></br><p style=word-wrap:break-word;overflow-wrap:break-word;white-space:normal>Bitcoin: bc1qzumgrjv2jjnxphny56246kjc9qur3uj5x95kzr<br>Monero: 4B7QhZcqMCMGCy7Fe9ifEjKCTXLs6UUpa9UAgQPDdenBMCk3oNKpSh313GTqKphu5uX5wgpyHAQ1kXEyH7ma7N9N8EKFxcV<br>Solana: wc94DzEAtsKofkx4EDjNwU3tvkHvPnGJAXgNJVpUtSK<br></p><p class=text-center><a href=https://t.me/+7XwHY3E3FDAyZjMx>Telegram</a> |
<a href=https://x.com/brazil0nchain>Twitter</a> |
<a href=https://discord.gg/fDGRFKFwcJ>Discord</a></p><script>const targetClass="binance-widget__footer",observer=new MutationObserver(()=>{const e=document.querySelector(`.${targetClass}`);e&&(console.log("Elemento encontrado! Removendo..."),e.remove(),observer.disconnect())});observer.observe(document.body,{childList:!0,subtree:!0})</script></footer></body><link rel=stylesheet href=/css/bootstrap.css><link rel=stylesheet href=/css/bootstrap-responsive.css><link rel=stylesheet href=/css/style.css><script src=/js/jquery.js></script><script src=/js/bootstrap-386.js></script><script src=/js/bootstrap-transition.js></script><script src=/js/bootstrap-alert.js></script><script src=/js/bootstrap-modal.js></script><script src=/js/bootstrap-dropdown.js></script><script src=/js/bootstrap-scrollspy.js></script><script src=/js/bootstrap-tab.js></script><script src=/js/bootstrap-tooltip.js></script><script src=/js/bootstrap-popover.js></script><script src=/js/bootstrap-button.js></script><script src=/js/bootstrap-collapse.js></script><script src=/js/bootstrap-carousel.js></script><script src=/js/bootstrap-typeahead.js></script><script src=/js/bootstrap-affix.js></script><script>_386={fastLoad:!1,onePass:!1,speedFactor:2.5};function ThisYear(){document.getElementById("thisyear").innerHTML=(new Date).getFullYear()}</script></html>